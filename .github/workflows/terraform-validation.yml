name: Terraform Validation

on:
  push:

jobs:
  terraform-fmt:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.8.0

      - name: Terraform Format Check
        id: fmt
        run: tofu fmt -check -recursive -diff
        continue-on-error: true

      - name: Comment on PR (Format)
        if: github.event_name == 'pull_request' && steps.fmt.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ❌ Terraform Format Check Failed\n\nPlease run `tofu fmt -recursive` to fix formatting issues.\n\n```bash\ncd ~/git/bedrock-s3-vectors-rag\ntofu fmt -recursive\n```'
            })

      - name: Fail if format check failed
        if: steps.fmt.outcome == 'failure'
        run: exit 1

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory:
          - "modules/lambda"
          - "modules/s3"
          - "modules/dynamodb"
          - "modules/api_gateway"
          - "modules/monitoring"
          - "modules/iam"
          - "examples/basic"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Show TFLint version
        run: tflint --version

      - name: Init TFLint
        run: tflint --init
        working-directory: ${{ matrix.directory }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run TFLint
        run: tflint --format compact --color
        working-directory: ${{ matrix.directory }}

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    needs: [terraform-fmt, tflint]
    strategy:
      matrix:
        directory:
          - "examples/basic"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.8.0

      - name: Terraform Init
        run: tofu init -backend=false
        working-directory: ${{ matrix.directory }}

      - name: Terraform Validate
        run: tofu validate
        working-directory: ${{ matrix.directory }}

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [terraform-fmt, tflint, terraform-validate]
    if: always()
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.terraform-fmt.result }}" == "success" ]] && \
             [[ "${{ needs.tflint.result }}" == "success" ]] && \
             [[ "${{ needs.terraform-validate.result }}" == "success" ]]; then
            echo "✅ All Terraform validation checks passed!"
            exit 0
          else
            echo "❌ Some Terraform validation checks failed:"
            echo "  - Format: ${{ needs.terraform-fmt.result }}"
            echo "  - TFLint: ${{ needs.tflint.result }}"
            echo "  - Validate: ${{ needs.terraform-validate.result }}"
            exit 1
          fi

      - name: Comment on PR (Success)
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ✅ All Terraform Validation Checks Passed!\n\n- ✅ Terraform Format\n- ✅ TFLint\n- ✅ Terraform Validate'
            })
